<!DOCTYPE html>
<html>
<head>
<title>Web Push Notification</title>
<meta content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, minimal-ui" name="viewport"/>
<meta name="google-site-verification" content="NHOzB95znXK1BY827-7oL_xrON_ReKdKF0pu5OiJtGg" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
</head>
<body>
<div id="not-chrome"> Your browser does not support this feature </div>
<div id="chrome">
	<form onsubmit="subscription(); return false;" id="subscribe-form">
	 <input type="email" value="" id="email" name="email" placeholder="Enter your email Id" required />
	  <button type="submit" id="subscribe">Subscribe</button>
	</form>
	<button type="button" id="unsubscribe" onclick="unsubscribe()">Unsubscribe</button>
</div>

<script>
	addEventListener('load', async()=> {
		if (navigator.userAgent.indexOf("Chrome") != -1 ) {
			let sw = await navigator.serviceWorker.register('./notify-sw.js');
			document.getElementById('not-chrome').remove();
			
			if(localStorage.getItem("subscribe") === "true"){
				document.getElementById('subscribe-form').remove();
			}else{
				document.getElementById('unsubscribe').remove();
			}
			
		} else {
			document.getElementById('chrome').remove();
		}
	});
	
	function subscription(){
		var email = document.getElementById('email').value;
		var subscribeBtn = document.getElementById('subscribe');
		if(localStorage.getItem("subscribe") === "false" || localStorage.getItem("subscribe") === null || localStorage.getItem("subscribe") === undefined){
			subscribeBtn.disabled = true;
			postAjax(location.origin+'/check-user', 'text/plain', email, function(data){ 
				data = JSON.parse(data);
				console.log(data);
				if(data.status === "notAllowed"){
					alert("This user not allowed for subscription");
				}
				if(data.status === true){
					alert("You are already subscribed !!");
				}
				if(data.status === false){
					subscriber(email);
				}
				subscribeBtn.disabled = false;		
			});
		}else{
			alert("This system already subsbcribed with other user");
		}
	}
	
	async function subscriber(email){
		let sw = await navigator.serviceWorker.ready;
		let push = await sw.pushManager.subscribe({
			userVisibleOnly : true,
			applicationServerKey: urlBase64ToUint8Array("BLb6aIeyzqzi58NGwfM5IjDw01bsJEbdQM4jHSjnYs83uEURDKR27Pw4TtlSelvEGzkVdyIMlU3RVd2KVYSAgcg")
		});
		
		var subscriberObj = {
			"email" : email,
			subscribed : true,
			subscription : JSON.stringify(push),
			isDinner :{tiffin_dinner:false,fruit_bowl:false},
			isTime :false,
			dinnerDone:false,
			timeDone:false
		}
		postAjax(location.origin+'/subscriber', 'text/plain', JSON.stringify(subscriberObj), function(data){
			data = JSON.parse(data);
			if(data.status === "yes"){
				localStorage.setItem("subscriber", email);
				localStorage.setItem("subscribe", true);
				window.location.href = window.location.origin;
			}
		});
	}
	
	
	async function unsubscribe(){
		var subscriberObj = {
			"email" : localStorage.getItem("subscriber"),
			subscribed : false
		}
		postAjax(location.origin+'/subscriber', 'text/plain', JSON.stringify(subscriberObj), function(data){
			data = JSON.parse(data);
			if(data){
				localStorage.removeItem("subscriber");
				localStorage.removeItem("subscribe");
				window.location.href = window.location.origin;
			}
		});
	}
	
	function urlBase64ToUint8Array(base64String) {
		var padding = '='.repeat((4 - base64String.length % 4) % 4);
		var base64 = (base64String + padding)
			.replace(/\-/g, '+')
			.replace(/_/g, '/');

		var rawData = window.atob(base64);
		var outputArray = new Uint8Array(rawData.length);

		for (var i = 0; i < rawData.length; ++i) {
			outputArray[i] = rawData.charCodeAt(i);
		}
		return outputArray;
	}
	
	function postAjax(url, contentType, data, success) {
		var params = typeof data == 'string' ? data : Object.keys(data).map(
				function(k){ return encodeURIComponent(k) + '=' + encodeURIComponent(data[k]) }
			).join('&');

		var xhr = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP");
		xhr.open('POST', url);
		xhr.onreadystatechange = function() {
			if (xhr.readyState>3 && xhr.status==200) { success(xhr.responseText); }
		};
		xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
		xhr.setRequestHeader('Content-Type', contentType);
		xhr.send(params);
		return xhr;
	}
</script>

</body>
</html>
