<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
 
	
	<script src="./jquery.min.js"></script>
    <title>O&S Automation</title>
	<style>
		.heading1{
			font-family: arial;
			font-size: 40px;
			text-align: center;
			color: #2875e9;
		}
		
		.button{
			padding: 15px;
			font-size: 16px;
			font-weight: bold;
			border: 1px solid #2875e9;
			border-radius: 5px;
			background: #2875e9;
			color: #fff;
			margin: 0 auto;
			width: 50%;
			display: block;
		    cursor: pointer;
		}
	</style>
  </head>
  <body>
    <h1 class="heading1">O&S Automation</h1>
    
	<button id="messsages" class="button" onclick="getMessages()">Check Unread Messages</button>

    <!-- You can also require other files to run in this process -->
  <script type="text/javascript">
			  
		function getMessages(){
			$.ajax({
				method: "POST",
				url: "https://gapi-notification.herokuapp.com/get-messages"
			}).done(function(result) {
				console.log(result);
				if(result.redirect === true){
					location.href = result.data;
				}else{
					var messageData = result.data;
					if(messageData.resultSizeEstimate > 0){
						console.log(messageData.messages);
						checkMessages(messageData.messages);
					}else{
						console.log(messageData);
					}
				}
			});
		}

		function checkMessages(messages){
			if(messages){
				var messageIds = [];
				for(var i=0; i < messages.length; i++){
					checkEachMessage(messages[i].id);
					messageIds.push(messages[i].id);
					if(i === messages.length - 1){
						modifyMessages(messageIds)
					}
				}
			}
		}
		
		function checkEachMessage(messageId){
			$.ajax({
				method: "POST",
				url: "https://gapi-notification.herokuapp.com/check-message",
				data:{'id': messageId}
			}).done(function(result) {
				if(result){
					var fullMessage = result;
					result = result.payload.headers;
					var subject = result.filter(function(data){
									return data.name === 'Subject';
								});
					subject = subject[0].value;
					console.log(subject);
					
					//Outbound SMS
					var isMatched = subject.includes("You have a new message at CorrLinks");	
					if(isMatched){
						var recipient = result.filter(function(data){
									return data.name === 'To';
								});
							recipient = recipient[0].value;
							recipient = recipient.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/gi);
							console.log(recipient);
							for (var i = 0; i < recipient.length; i++){
								triggerAutomation(recipient[i]);
							}
							
					}
					
					
					//Inbound SMS
					var sender = result.filter(function(data){
									return data.name === 'From';
								});
						sender = sender[0].value;
					var isSmsMatched = sender.includes("@sms.didforsale.com");
					isSmsMatched = true;
					if(isSmsMatched){
						//Get Number from Subject
						var subjectSMS = subject;
						var phoneNumber = subjectSMS.match(/(\d+)/);
						phoneNumber = phoneNumber[0];
						
						//Get Message from Body
						var messageBody = '';
						if(fullMessage.payload.mimeType === "text/plain"){
							messageBody = fullMessage.payload.body.data;
						} else if(fullMessage.payload.parts[0].mimeType === "text/plain"){
							messageBody = fullMessage.payload.parts[0].body.data;
						} else if(fullMessage.payload.parts[0].parts[0].mimeType === "text/plain"){
							messageBody = fullMessage.payload.parts[0].parts[0].body.data;
						}
						console.log(messageBody);
						messageBody = atob(messageBody);
						messageBody = messageBody.replace('*Message:*', '');
						console.log(messageBody);
						triggerSMSAutomation(phoneNumber, messageBody);	
					}
				}
			});
		}

		async function triggerAutomation(email){
			var credentials = await getCorrlinksCredentials(email);
			console.log(credentials);
			if(credentials.totalSize == 1){
				window.open("https://www.corrlinks.com/Login.aspx?username="+credentials.records[0].Corrlinks_Username__c+"&password="+credentials.records[0].Corrlinks_Password__c, "_blank");
			}
			/*getCredentials.then(async function(credentials){
				var getUser = await credentials.filter(function(data){
							return data.email === email;
						});
				console.log(getUser.length);
				if(getUser.length !== 0){
					window.open("https://www.corrlinks.com/Login.aspx?username="+getUser[0].email+"&password="+getUser[0].password, "_blank");
				}				
			});*/
		}
		
		async function triggerSMSAutomation(phoneNumber, messageBody){
			var inboundMessage = await saveMessage(phoneNumber, messageBody);
			console.log(inboundMessage);
		
			/*getCredentials.then(function(credentials){
				var getUser = credentials.filter(function(data){
							return data.phoneNumber === smsNumber;
						});
				console.log(getUser.length);
				if(getUser.length !== 0){
					window.open("https://www.corrlinks.com/Login.aspx?username="+getUser[0].email+"&password="+getUser[0].password, "_blank");
				}				
			});*/
		}
		
		function modifyMessages(messagesIds){
			console.log(messagesIds);
			$.ajax({
				method: "POST",
				url: "https://gapi-notification.herokuapp.com/modify-message",
				data: {'ids': JSON.stringify(messagesIds)}
			}).done(function(result) {
				console.log(result);
			});
		}
		
		
		
		
		
		//Retrive, Create & Update Salesfore Data
		
		var getCredentials = new Promise( function(resolve, reject){
								var credentials = [
									{"email":"remmy@osinmatetextingservice.com", "password":"Praiseyah@23"},
									{"email":"rgordon.aicpa@gmail.com", "password":"Ostexting2@1001"}
								]
								resolve(credentials);
							});
		
		
		function getCorrlinksCredentials(emailId){
			return new Promise((resolve, reject) => {
				$.ajax({
					method: "POST",
					url: "https://gapi-notification.herokuapp.com/corrlinks-credentials",
					data:{'email': emailId}
				}).done(function(result) {
					console.log(result);
					resolve(result);
				});
			});
		}
		
		function saveMessage(phoneNumber, messageBody){
			return new Promise((resolve, reject) => {
				$.ajax({
					method: "POST",
					url: "https://gapi-notification.herokuapp.com/save-message",
					data:{'email': emailId, 'message':messageBody}
				}).done(function(result) {
					console.log(result);
					resolve(result);
				});
			});
		}
		
		
		
		getMessages();
		setInterval(function(){ 
			getMessages();
		}, 60000);
	  </script>
  </body>
</html>
